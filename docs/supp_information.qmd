---
title: "Supporting Information for: *Flexible phylogenetic generalised mixed-effects models implementations for ecological data with repeated measures: a simulation study*"
author: "C. Williams"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
format:
  html:
    page-layout: full
    toc: true
    toc-location: left
    toc-depth: 3
    theme: cosmo
    embed-resources: true
    code-fold: show
    code-tools: true
    number-sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup}
#| output: false
#| warning: false
#| label: packages
#| code-overflow: wrap
#| code-fold: true

pacman::p_load(
  rmarkdown, readr, dplyr, purrr, splitstackshape, tidyverse, tidyr, ggplot2,
  vroom, details, sessioninfo, devtools, readxl, forcats, stringr, ape, phytools, 
  geiger, data.table, pavo
)

options(digits = 3, scipen = 5)
```


This webpage provides supporting information to the main text. It is organised into three sections. The first section describes the simulated models and data generating mechanisms. The second section presents a breakdown of compilation and sampling runtimes for the Bayesian MCMC models. The final section provides two case studies that demonstrate how the methods can be applied to real-world data.

For any comments or questions please contact: Coralie Williams^[coralie.williams@unsw.edu.au]


# Simulated models supporting methods

Here is an example of fitting the model using 5 different packages (which are used in our simulation study).


```{r}
### set up model parameters 
seed <- 1
b0 <- 1
b1 <- 1.5
k.species <- 25
n.reps <- 10 #balanced design
sigma2.s <- 0.25
sigma2.p <- 0.25
sigma2.e <- 0.2

```


Simulate some data based on these parameter values:


```{r}
#| cache: true 
#| eval: false
#| echo: false

### set seed
set.seed(seed)

### set up k.obs (number of observations per species)
if (n.reps==999) {
  k.obs <- round(rbeta(n = k.species, shape1 = 1.25, shape2 = 3) * 99) + 1
} else {
  k.obs <- n.reps
}

### create species id variable
sp.id <- rep(seq_len(k.species), times=k.obs)

### total number of observations
n <- length(sp.id)

### simulate simple dataframe with covariate (x) variable
x <- runif(n, 10, 20) 
dat <- data.frame(obs = 1:n, x = x, species = sp.id)

### simulate tree and obtain phylo matrix
tree <- rtree(k.species, tip.label = seq_len(k.species))
tree <- compute.brlen(tree, power=1) 
phylo.mat <- vcv(tree, corr = TRUE) ## we want correlation matrix (bounded by -1 and 1)
phylo.mat <- phylo.mat[order(as.numeric(rownames(phylo.mat))), order(as.numeric(rownames(phylo.mat)))]


### Simulate response variable (phen) based on cofactor and phylogenetic matrix
u.s <- rnorm(k.species, 0, sqrt(sigma2.s))[sp.id]
u.p <- mvrnorm(1, mu=rep(0, k.species), Sigma=sigma2.p*phylo.mat)[sp.id]
ei <- rnorm(n, 0, sqrt(sigma2.e))

### get estimates of y
yi <- b0 + b1*x + u.s + u.p + ei

### append all to dataframe
dat <- cbind(dat, u.s, u.p, ei, b0, b1, yi)
dat$phylo <- dat$species # phylo ID variable (same as species) - needs to be numeric to work with INLA
dat$species <- factor(dat$species) # format species variable for models
dat$sp <- dat$species # create sp variable (for phyr)
dat$g <- 1 # add variable g constant (for glmmTMB)

# save simulated data as R file
save(list = "dat", file = paste0("data/simdat_", job, ".RDATA"))

```


Run models:


```{r}
#| cache: true 
#| eval: false
#| echo: false



```





# Bayesian MCMC model runtime breakdown



```{r}
#| cache: true 
#| eval: false
#| echo: false



```





# Case studies: bird coloration

## Background

What evolutionary processes have led to current color distribution in birds? With this analysis we can understand whether the coloration patterns are a result of factors such as sexual selection, predation pressure, or habitat preferences, among others. Furthermore, it can guide future research and experiments by suggesting specific evolutionary questions to investigate.


## Case study 1

### Data overview

Load data and phylogenetic tree

```{r}
#| eval: false


# Load bird spectrum data 
bird_data <- read_delim("data/Spec_IndivReg_Coralie.csv", 
    delim = ";", escape_double = FALSE, locale = locale(decimal_mark = ","), 
    trim_ws = TRUE)

# summary of birds species and genus
length(table(bird_data$genus_original)) # 446 genus
length(table(bird_data$sci_name_Jetz)) # 949 species
#length(table(bird_data$sci_name_original)) # 952 original species

### Notes
# individuals a-c are make and d-f are female
#table(bird_data$sex, bird_data$individual)

# number of measurements?
#table(bird_data$Nmeasured)

# duplicates per individual per body region
#dup <- dat |>
#    summarise(n = n(), 
#              .by = c(wl, individual_nonrep, sex, body_region))
#r <- dup[which(dup$n>1),]
#table(r$individual_nonrep)

# Remove the specified species from bird_data
bird_data <- bird_data |> 
  filter(!sci_name_Jetz %in% c("Basileuterus_rufifrons", "Malurus_lamberti", "Malurus_splendens"))
```


**Some notes:**

-   Spectral values are reflectance data -- are they normalised.

-   Nmeasured is the number of measurements per patch. 

-   Each body region measured 5 times (then averaged).

-   These species seem to have two measurements per body region per individual:

    ```         
    Basileuterus_rufifrons, Malurus_lamberti, Malurus_splendens
    ```

### Phylogenetic tree set-up

```{r}
#| output: false
#| warnings: false
#| eval: false

# Load bird tree (consensus tree = "combined tree")
bird.tree <- read.tree("data/Stage2_Hackett_MCC_no_neg.tre")

### Prune bird tree
bird.pruned <- keep.tip(bird.tree, bird_data$sci_name_Jetz)
# check whether names match in data and tree
check <- name.check(bird.pruned, bird_data$sci_name_Jetz, sort(bird.pruned$tip.label))

# plot tree
plotTree(bird.pruned, ftype="i", fsize=0.4, lwd=1, type="fan")

```

```{r}
########################################## 
# # random code ---- testing on other dataset
# df <- t(read.csv("http://openmv.net/file/tablet-spectra.csv", header = FALSE))
# df <- df[-1, ]
# df <- apply(df, 2, as.numeric)
# df <- cbind(wl = seq_len(nrow(df)),df)
# 
# df <- as.rspec(df)
# #> wavelengths found in column 1
# 
# plot(df, ylab = "Absorbance", col = rainbow(3))
########################################################################
```

### Color data set-up

#### Obtain wavelength dataset

```{r}
#| eval: false

# set up wavelength dataset (wavelengths columns 300 to 474)
dat <- bird_data |> 
  pivot_longer(cols = `300`:`700`, names_to="wl", values_to="refl") |> 
  select(individual_nonrep, body_region, sex, wl, refl) |> 
  mutate(wl = as.numeric(wl))

# pivot so each column is an individual body region measurement
dat2 <- dat |> 
  pivot_wider(names_from = c("individual_nonrep", "sex", "body_region"),
              values_from = "refl", names_sep = ".")

# create spectral dataset with pavo
specs <- as.rspec(dat2)

# example one bird, one body region
plot(Acrocephalus_palustris_a.Male.throat ~ wl, type="l", data=specs)
plot(Alle_alle_a.Male.throat ~ wl, type="l", data=specs)


# create a vector with species identity names
spp <- gsub("\\_[a-f]\\..*$", "", names(specs))[-1]
table(spp)

# aggregate species by mean value
sppspec <- aggspec(specs, by = spp, FUN = mean)
round(sppspec[1:5, 1:5], 2)



# check for missing values
plotsmooth(specs[,1:7],
  minsmooth = 0.05,
  maxsmooth = 0.5,
  curves = 4,
  ask = FALSE
)


# use procspec to adjust negative values
specs <- procspec(specs, fixneg="addmin")

# automatically corrects - by shifting or trimming negative values can be due to darker colors (using addmin argument)

plot(specs, select = 10)

```

#### Obtain spectral shape descriptors

-   Focus on Brightness and Saturation

-   

```{r}
#| eval: false

# Obtain spectral shape descriptors: https://book.colrverse.com/spectral-shape-descriptors.html
spec.des <- summary(specs, subset = c("B1", "B2")) ## this makes it faster to run 
spec.des <- summary(specs)

# Add S1U - ultrabiolet

# Format H4 (Hue) - add 2pi to negative
#spec.des



# distribution of shape descriptors
hist(spec.des$B1)
hist(spec.des$S1)
hist(spec.des$S9)
hist(spec.des$H4)

```

#### Obtain visual models

```{r}
#| eval: false

# average ultraviolet-sensitive avian (tetrachromat)
vis.avian.avg <- vismodel(specs, visual="avg.uv")
# the blue tit Cyanistes caeruleus (tetrachromat)
vis.bluetit <- vismodel(specs, visual="bluetit")

# distribution of descriptors
hist(vis.bluetit$u)
hist(vis.bluetit$s)
hist(vis.bluetit$m)
hist(vis.bluetit$l)

# TCS - color space model to get shape descriptors 
# provides three parameters (R= color saturation, H+theta= like a Hue (H4), H5 = amount of ultraviolet)
```

#### Formatting data for modelling

Most morphological traits need to be log-ed (due to evolutionary; most traits evolve by multiplying rather then additive). =\> create new variable.

Check predictors if they need to be centered.

```{r}
#| eval: false



spec.des$rowname <- rownames(spec.des)

spec.dat <- spec.des |> 
  mutate(sex = case_when(
    grepl("Male", rowname) ~ "male",
    grepl("Female", rowname) ~ "female"),
    species = gsub("\\_[a-f]\\..*$", "", rowname),
    body_region = str_extract(rowname, "[a-z]+$")
  ) 

save(spec.dat, file="data/spec_data_for_model.csv")
```

### Modelling

```{r}
#| eval: false


# function to get run time 
rtime <- function(...) unname(system.time(capture.output(...))["elapsed"])

# load data
#spec.dat <- read_csv("data/spec_data_for_model.csv")
```




#### Brightness 

```{r}
#| output: false
#| warnings: false
#| eval: false


# set up phylogenetic correlation matrix
phylo.mat <- vcv(bird.pruned, corr = TRUE) 
phylo.mat <- phylo.mat[sort(rownames(phylo.mat)), sort(rownames(phylo.mat))]

# checks   
#length(colnames(phylo.mat))==length(table(spec.dat$species))
# head(rownames(phylo.mat))
# head(colnames(phylo.mat))
# head(table(spec.dat$species))

                                    
##### glmmTMB model -----------------------------
library(glmmTMB)
spec.dat$g <- 1

## model 1 - gaussian response (time: 42.8 seconds)
time.glmmTMB <- rtime(mod1.b <- glmmTMB(B1 ~ body_region * sex + (1|species) + propto(0 + species|g,phylo.mat), data = spec.dat, REML=TRUE))

fit.glmmTMB <- summary(mod1.b)
AIC(mod1.b)

coefs_tmb <- as.data.frame(confint(mod1.b, parm="beta_"))
re_tmb <- as.data.frame(confint(mod1.b, parm="theta_"))

mod1.b$sdr$pdHess



## model 2 - gaussian response (time: 35.2 seconds)
time.glmmTMB <- rtime(mod2.b <- glmmTMB(log(B1) ~ body_region * sex + (1|species) + propto(0 + species|g,phylo.mat), data = spec.dat, REML=TRUE))

fit.glmmTMB <- summary(mod2.b)
AIC(mod2.b)

coefs_tmb <- as.data.frame(confint(mod2.b, parm="beta_"))
re_tmb <- as.data.frame(confint(mod2.b, parm="theta_"))




##########################################################################

### Body count of color
# Overdispersed Poisson compois (Conway-Maxwell Poisson) response
### Absence or presence of color
# Binomial response
# 

## model 3 - negative binomial response (time: 55.22 seconds)
time.glmmTMB <- rtime(mod2.b <- glmmTMB(log(B1) ~ body_region * sex + (1|species) + propto(0 + species|g,phylo.mat), data = spec.dat, REML=TRUE))

fit.glmmTMB <- summary(mod2.b)
AIC(mod2.b)

coefs_tmb <- as.data.frame(confint(mod2.b, parm="beta_"))
re_tmb <- as.data.frame(confint(mod2.b, parm="theta_"))


## model 4 - add sex in
time.glmmTMB <- rtime(mod2.b <- glmmTMB(log(B1) ~ body_region * sex + (1|species) + propto(0 + species|g,phylo.mat), data = spec.dat, REML=TRUE))

fit.glmmTMB <- summary(mod2.b)
AIC(mod2.b)

coefs_tmb <- as.data.frame(confint(mod2.b, parm="beta_"))
re_tmb <- as.data.frame(confint(mod2.b, parm="theta_"))

```



## Case study 2









# References



# Session information

```{r}
#| label: Reproducibility-SessionInfo-R-environment
#| fig-align: "center"
#| out-width: '100%'
#| results: asis
#| message: false
#| warnings: false

library(sessioninfo)
library(details)

si <- session_info()
si$packages <- si$packages 
  # |> filter(package %in% c("metafor", "ape", "clubSandwich", "Matrix", "corpcor", "dplyr", "kableExtra", "xtable", "rotl", "Hmisc", "lattice"))

details(si, summary = 'Current session info', open = FALSE)

```